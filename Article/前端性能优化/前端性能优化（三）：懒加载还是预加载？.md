# 前端性能优化（三）：懒加载还是预加载？

有时候要懒加载，有时候又要预加载，看起来似乎是互相矛盾的两种手段。其实并不然，雅虎军规对它们的关系也解释得非常清楚，对同一个组件，可以懒加载的同时进行预加载。

## 懒加载

懒加载即延迟加载，上篇文章中也说到，对于不是首屏渲染必要的图片、组件等，可以延迟加载。

懒加载有以下有点：

1. 加快首屏加载速度
2. 减轻服务器压力
3. 节约流量

### 图片懒加载

图片懒加载是一个常见优化点。其原理是

1. 对图片的src赋值一张1*1的gif（体积最小）或其他简单的占位图片，而将真正的图片地址用其他属性（如`data-original`）保存。
2. 页面加载完成时，获取页面所有图片标签，判断其是否在页面内，是的话将`data-original`的地址赋值给图片的src属性，浏览器开始下载图片。
3. 监听滚动事件，判断图片是否进入页面内，是的话用第2步中的方法加载图片。

后续有文章具体实现。

### 组件懒加载

SPA首屏速度一直是一个硬伤，组件懒加载可以有效地优化SPA的首屏速度。

以Vue为例，对于其他页面组件，在第一次访问时并不需要加载，通过webpack提供的`import()`方法，将其打包成异步模块，当访问对应路由时再进行加载。

```js
{
    path: '/home',
    name: 'Home',
    component: () => import(/* webpackChunkName: "Home" */ '@/views/home')
}
```
弹窗组件也可以使用同样的方式进行优化，并在加载完成后的回调函数中执行下一步操作。
```js
import('./modal.js')
    .then(modal => {
        modal.show()
    })
    .catch(err => {})
```

## 预加载

预加载与懒加载恰好相反。预加载会预先加载用户即将访问的内容，当用户访问时直接读取缓存，节省了加载时间，提高用户体验。如小说网站，可以预先加载下面几章的内容，让用户可以流畅观看。

预加载的优点是提高了用户体验，减少了加载、白屏的时间，但同时需要以增加服务器压力为代价。

### 图片预加载

```js
let image = new Image()
image.src = '//xxx.com/images/1.jpg'
```
除了用js进行图片预加载之外，还可以用`PreloadJS`之类的库。

### 组件预加载

在页面加载完成后，手动插入script标签可以实现模块的预加载。即异步加载js。

在webpack中，使用魔法注释可以对异步组件模块进行预拉取和预加载

```js
/* webpackPrefetch: true */
/* webpackPreload: true */
```

### dns-prefetch

`dns-prefetch`可以提前去对域名进行dns解析，只需要在head中加入这样一样代码

```html
<link rel="dns-prefetch" href="//xxx.com">
```

除此之外，还有预链接，预加载，预渲染。webpack中的魔法注释的原理就是这个。

```html
<link rel="preconnect" href="//xxx.com" crossorigin>

<link rel="prefetch" href="//xxx.com/index.js" as="script">

<link rel="prerender" href="//xxx.com/index.html">
```

## 懒加载和预加载的关系

懒加载和预加载并不矛盾。懒加载目的在于提高首屏的加载速度，而预加载在于提高后续的用户体验。预加载一般在浏览器空闲的时候进行。

对于一些图片或弹窗组件，我们可以在首屏加载的时候对其进行懒加载，当首屏加载完成，浏览器空闲时再对其进行预加载。这样即保持了首屏加载速度，又可以提高了用户体验。
