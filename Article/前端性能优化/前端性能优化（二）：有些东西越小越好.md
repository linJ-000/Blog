# 前端性能优化（二）：有些东西越小越好

前端性能优化从网络的层面考虑就是要**减小请求体积，减少请求数量**。

## 减少文件体积

### 文件压缩

减少文件体积首先就是各种压缩。如js混淆压缩，html压缩。

通过cssnano不仅可以对css进行压缩，还可以去掉css中的无效规则。

最后是图片压缩，可用[tinypng](https://tinypng.com/)网站对jpg或png格式的图片进行压缩。

### 图片优化

用过lighthouse的会发现，图片是优化的重点，也是资源体积中的大头。首先要了解常用的各种图片格式：

1. png

    png是⼀种⽆损压缩的位图图形格式，⽀持索引、灰度、RGB三
种颜⾊⽅案以及Alpha通道等特性。png支持透明度，在网页中有广泛的应用。常用在**logo**，**质量要求高但颜色简单的图片**及**雪碧图**等地方。

2. jpg/jpeg

    jpg/jpeg是一种有损压缩格式，可在不影响用户分辨图片质量的前提下，尽可能地压缩图片大小。常用在**banner大图**，**背景图片**等地方。

3. gif

    gif是⼀种基于LZW算法的连续⾊调的⽆损压缩格式。它的压缩率⼀般在50%左右。gif可使用简单的动画，如常见的表情包。常用在**加载的loading**，以及一些**简单的动画**。

4. svg

    svg是⼀种基于XML语法的图像格式，全称是可缩放⽮量图。svg体积小，可压缩性强，具有缩放而不失真的特点，常用来**绘制地图**，**股票K线图**以及一些**小图标**。但svg是一种基于文档标记语法的格式，需要被浏览器解析，会带来一些性能损耗。

5. webp

    webp格式是⾕歌开发的⼀种旨在加快图⽚加载速度的图⽚格式。具有无损压缩和有损压缩的能力，且比png及jpg拥有更多的压缩率。未来是一种全能的解决方案，但当下对浏览器的兼容很差，仅Chrome对其有较好的支持。

6. base64

    base64就是⼀种基于64个可打印字符来表示⼆进制数据的⽅法。可理解为将图片转换成字符串。但转换后体积会变大，适合一些**小图标**，将图片转成base64打包进脚本文件，可以减少http请求数量，可替代雪碧图。

在不同的场景使用不同的图片格式可以有效优化图片体积，提高用户体验。

### Gzip

提压缩就必须提Gzip。在经过上面提到的文件压缩的基础上，Gzip能再压缩50%左右。但是需要服务端和浏览器都支持Gzip。通过HTTP响应头的`content-encoding`字段可以判断该资源是否开启了Gzip压缩。
```bash
content-encoding: gzip
```

## 减少请求数量

### 雪碧图（CSS sprite）

将小图标合并成一张大图，使用`background-position`定位到正确的图标，从而减少请求数量。

现在很多技术都可以自动生成雪碧图，如less，grunt的grunt-sprite插件以及webpack的webpack-spritesmith插件，使用方便，满足各种技术栈的需求。

### js css打包

与上述的雪碧图都是一种合并的思想。通过将多个请求合并成一个以减少请求数量。打包合并js和css文件同时需要注意作用域污染的问题。

js文件可通过模块化解决。

css的隔离方案：如vue的scoped，qiankun微前端框架的shadow-dom。

在打包的同时还需要考虑拆分。因为单个大文件会导致加载时间长的问题。而浏览器最多可同时发送5个http请求，有效的拆分可以充分地利用浏览器资源。

### 浏览器缓存

通过强缓存，协商缓存等方式，浏览器可直接读取本地缓存文件而不用重新从服务器请求。

了解更多详细内容请浏览后续文章。

### 懒加载

为了使首屏加载时间更短，加载速度更快，我们可以对一些组件，图片进行懒加载操作。即对一些不是立刻显示的内容，我们在首次加载地时候不去加载它们，比如需要点击按钮才出现的弹窗，页面外的图片等，直到某些条件触发时才去加载，以缩短首屏的加载时间。
